name: Auto-Merge on Manual Approval

# This workflow automatically enables auto-merge when a trusted contributor
# approves a PR that Claude has already approved but requires manual merge
# (e.g., production dependencies with minor/major updates)

on:
  pull_request_review:
    types:
      - submitted

permissions:
  contents: write
  pull-requests: write

# Prevent concurrent workflow runs for the same PR
# This prevents race conditions when multiple approvals happen rapidly
concurrency:
  group: auto-merge-${{ github.event.pull_request.number }}
  cancel-in-progress: false # Let current run finish, queue new runs

jobs:
  auto-merge-on-approval:
    name: Enable Auto-Merge on Approval
    runs-on: ubuntu-latest
    # Only run on approved reviews
    if: github.event.review.state == 'approved'

    steps:
      - name: Check if PR is ready for auto-merge
        id: check-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # Enable debug mode if ACTIONS_STEP_DEBUG is set
          if [ "$ACTIONS_STEP_DEBUG" = "true" ]; then
            set -x
            echo "üêõ Debug mode enabled"
          fi

          # Get PR labels
          labels=$(gh pr view "$PR_URL" --json labels --jq '.labels[].name' | tr '\n' ',')

          echo "‚ÑπÔ∏è  PR labels: $labels"

          # Check if PR has both required labels
          if echo "$labels" | grep -q "ready-to-merge" && echo "$labels" | grep -q "dependabot-approved"; then
            echo "is_ready=true" >> $GITHUB_OUTPUT
            echo "‚úÖ PR has required labels (ready-to-merge + dependabot-approved)"
          else
            echo "is_ready=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  PR does not have required labels"
          fi

      # Checkout repository for reusable actions
      # IMPORTANT: Must run before verify-reviewer step
      - name: Checkout repository
        if: steps.check-pr.outputs.is_ready == 'true'
        uses: actions/checkout@v6
        with:
          sparse-checkout: |
            .github/actions
          sparse-checkout-cone-mode: false

      # Verify reviewer identity matches the review event
      - name: Verify reviewer identity
        if: steps.check-pr.outputs.is_ready == 'true'
        id: verify-identity
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          EXPECTED_REVIEWER: ${{ github.event.review.user.login }}
        run: |
          # Enable debug mode if ACTIONS_STEP_DEBUG is set
          if [ "$ACTIONS_STEP_DEBUG" = "true" ]; then
            set -x
            echo "üêõ Debug mode enabled"
          fi

          echo "‚ÑπÔ∏è  Verifying reviewer identity: $EXPECTED_REVIEWER"

          # Get the actual latest approved review from API
          latest_review=$(gh api "/repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews" \
            --jq '[.[] | select(.state == "APPROVED")] | last')

          if [ -z "$latest_review" ] || [ "$latest_review" = "null" ]; then
            echo "‚ùå No approved reviews found"
            exit 1
          fi

          latest_reviewer=$(echo "$latest_review" | jq -r '.user.login')

          if [ "$latest_reviewer" != "$EXPECTED_REVIEWER" ]; then
            echo "‚ùå Reviewer mismatch: expected $EXPECTED_REVIEWER, got $latest_reviewer"
            exit 1
          fi

          echo "‚úÖ Reviewer identity verified: $latest_reviewer"

      # Verify reviewer is a trusted contributor using reusable action
      - name: Verify reviewer is a trusted contributor
        if: steps.check-pr.outputs.is_ready == 'true'
        id: verify-reviewer
        uses: ./.github/actions/verify-trusted-contributor
        with:
          username: ${{ github.event.review.user.login }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check CI status
        if: |
          steps.check-pr.outputs.is_ready == 'true' &&
          steps.verify-reviewer.outputs.is_trusted == 'true'
        id: check-ci
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          # Enable debug mode if ACTIONS_STEP_DEBUG is set
          if [ "$ACTIONS_STEP_DEBUG" = "true" ]; then
            set -x
            echo "üêõ Debug mode enabled"
          fi

          # Get CI status for the PR
          status=$(gh pr view "$PR_URL" --json statusCheckRollup --jq '.statusCheckRollup[].state' | sort -u | tr '\n' ',')

          echo "‚ÑπÔ∏è  CI status: $status"

          # Check if all checks are passing or pending (no failures)
          if echo "$status" | grep -qE "(FAILURE|ERROR)"; then
            echo "ci_ready=false" >> $GITHUB_OUTPUT
            echo "‚ùå CI checks have failures"
          else
            echo "ci_ready=true" >> $GITHUB_OUTPUT
            echo "‚úÖ CI checks are passing or pending"
          fi

      - name: Extract commit message from Claude's comment
        if: |
          steps.check-pr.outputs.is_ready == 'true' &&
          steps.verify-reviewer.outputs.is_trusted == 'true' &&
          steps.check-ci.outputs.ci_ready == 'true'
        id: extract-commit-msg
        uses: ./.github/actions/extract-claude-commit-message
        with:
          pr-url: ${{ github.event.pull_request.html_url }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch Dependabot metadata (fallback)
        if: |
          steps.check-pr.outputs.is_ready == 'true' &&
          steps.verify-reviewer.outputs.is_trusted == 'true' &&
          steps.check-ci.outputs.ci_ready == 'true'
        id: dep-metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable auto-merge
        if: |
          steps.check-pr.outputs.is_ready == 'true' &&
          steps.verify-reviewer.outputs.is_trusted == 'true' &&
          steps.check-ci.outputs.ci_ready == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REVIEWER: ${{ github.event.review.user.login }}
          COMMIT_SUBJECT: ${{ steps.extract-commit-msg.outputs.commit_subject }}
          COMMIT_BODY: ${{ steps.extract-commit-msg.outputs.commit_body }}
          # Fallback metadata
          ECOSYSTEM: ${{ steps.dep-metadata.outputs.package-ecosystem }}
          DEPENDENCY_NAMES: ${{ steps.dep-metadata.outputs.dependency-names }}
          PREV_VERSION: ${{ steps.dep-metadata.outputs.previous-version }}
          NEW_VERSION: ${{ steps.dep-metadata.outputs.new-version }}
        run: |
          # Enable debug mode if ACTIONS_STEP_DEBUG is set
          if [ "$ACTIONS_STEP_DEBUG" = "true" ]; then
            set -x
            echo "üêõ Debug mode enabled"
          fi

          # Use Claude's commit message if available, otherwise fallback
          if [ -n "$COMMIT_SUBJECT" ]; then
            echo "‚ÑπÔ∏è  Using Claude-suggested commit message"
            commit_subject="$COMMIT_SUBJECT"
            commit_body="$COMMIT_BODY"
          else
            echo "‚ÑπÔ∏è  Using fallback commit message format"
            commit_subject="chore(deps)($ECOSYSTEM): bump $DEPENDENCY_NAMES from $PREV_VERSION to $NEW_VERSION (#$PR_NUMBER)"
            commit_body="Automated dependency update."
          fi

          echo "‚ÑπÔ∏è  Commit subject: $commit_subject"

          # Validate commit subject is not empty
          if [ -z "$commit_subject" ]; then
            echo "‚ùå Commit subject is empty - cannot enable auto-merge"
            exit 1
          fi

          # Enable auto-merge with commit message
          if [ -n "$commit_body" ]; then
            gh pr merge --auto --squash --subject "$commit_subject" --body "$commit_body" "$PR_URL"
          else
            gh pr merge --auto --squash --subject "$commit_subject" "$PR_URL"
          fi

          gh pr edit "$PR_URL" --add-label "dependabot-auto-merge"

          gh pr comment "$PR_URL" --body "‚úÖ **Auto-merge enabled** - Approved by @$REVIEWER (trusted contributor). PR will merge automatically after all CI checks pass."

          echo "‚úÖ Auto-merge enabled successfully"

      - name: Post security warning if reviewer is not trusted
        if: |
          steps.check-pr.outputs.is_ready == 'true' &&
          steps.verify-reviewer.outputs.is-trusted != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          REVIEWER: ${{ github.event.review.user.login }}
          REASON: ${{ steps.verify-reviewer.outputs.reason }}
        run: |
          # Enable debug mode if ACTIONS_STEP_DEBUG is set
          if [ "$ACTIONS_STEP_DEBUG" = "true" ]; then
            set -x
            echo "üêõ Debug mode enabled"
          fi

          gh pr comment "$PR_URL" --body "‚ö†Ô∏è **Manual Merge Required** - Approval from @$REVIEWER detected, but contributor is not trusted.

          **Reason:** $REASON

          A trusted contributor must approve or manually merge this PR."

          echo "‚ö†Ô∏è  Security warning posted: $REASON"
