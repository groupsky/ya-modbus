name: Cleanup Pre-release

on:
  pull_request:
    types: [closed]

permissions:
  contents: read # Only need to read the repository

jobs:
  cleanup:
    name: Remove Pre-release dist-tags
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js from .nvmrc
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Extract dist-tags from PR comments
        id: dist-tags
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"

          # Get all comments on this PR and extract dist-tags from our special marker
          DIST_TAGS=$(gh pr view $PR_NUMBER --json comments --jq '.comments[].body' | \
            grep -o 'ya-modbus-prerelease: [a-zA-Z0-9-]*' | \
            sed 's/ya-modbus-prerelease: //' | \
            sort -u | \
            tr '\n' ' ')

          if [ -z "$DIST_TAGS" ]; then
            echo "â„¹ï¸ No pre-release dist-tags found in PR comments"
            echo "has_tags=false" >> $GITHUB_OUTPUT
            echo "dist_tags=" >> $GITHUB_OUTPUT
          else
            echo "has_tags=true" >> $GITHUB_OUTPUT
            echo "dist_tags=$DIST_TAGS" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Found dist-tags to remove: $DIST_TAGS"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get package list
        if: steps.dist-tags.outputs.has_tags == 'true'
        id: packages
        run: |
          # Extract non-private package names from workspace using npm query
          PACKAGES=$(npm query ".workspace:not([private])" | jq -r '.[].name' | tr '\n' ' ')
          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Packages: $PACKAGES"

      - name: Remove dist-tags
        if: steps.dist-tags.outputs.has_tags == 'true'
        run: |
          DIST_TAGS="${{ steps.dist-tags.outputs.dist_tags }}"
          EXIT_CODE=0

          for DIST_TAG in $DIST_TAGS; do
            echo "Processing dist-tag: $DIST_TAG"

            for pkg in ${{ steps.packages.outputs.packages }}; do
              echo "  Checking $pkg..."

              # Check if dist-tag exists
              if npm dist-tag ls "$pkg" 2>/dev/null | grep -q "^$DIST_TAG:"; then
                echo "    âœ“ Found dist-tag $DIST_TAG for $pkg, removing..."
                if npm dist-tag rm "$pkg" "$DIST_TAG"; then
                  echo "    âœ… Successfully removed dist-tag"
                else
                  echo "    âŒ Failed to remove dist-tag"
                  EXIT_CODE=1
                fi
              else
                echo "    â„¹ï¸ No dist-tag $DIST_TAG for $pkg"
              fi
            done
          done

          exit $EXIT_CODE
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Summary
        if: always()
        run: |
          echo "## Pre-release Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- PR: #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.event.pull_request.head.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ github.event.pull_request.merged && 'Merged' || 'Closed without merge' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.dist-tags.outputs.has_tags }}" == "true" ]; then
            echo "**Dist-tags removed**: \`${{ steps.dist-tags.outputs.dist_tags }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Pre-release versions remain available but the dist-tags have been removed." >> $GITHUB_STEP_SUMMARY
          else
            echo "**No pre-release dist-tags found** - nothing to clean up." >> $GITHUB_STEP_SUMMARY
          fi
