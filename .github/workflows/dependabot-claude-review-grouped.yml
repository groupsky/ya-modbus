name: Dependabot + Claude Review (Grouped)

# This workflow handles Dependabot PRs that contain MULTIPLE dependencies (groups)
# For single-dependency PRs, see dependabot-claude-review.yml

on:
  pull_request_target:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read

jobs:
  # Detect if this is a grouped PR
  detect-group:
    name: Detect Grouped PR
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    outputs:
      is-grouped: ${{ steps.check.outputs.is_grouped }}
      dependency-count: ${{ steps.check.outputs.dependency_count }}

    steps:
      - name: Check if grouped PR
        id: check
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine if grouped
        id: analyze
        run: |
          # Count dependencies (comma-separated)
          deps="${{ steps.check.outputs.dependency-names }}"
          count=$(echo "$deps" | tr ',' '\n' | wc -l)

          echo "dependency_count=$count" >> $GITHUB_OUTPUT

          if [ "$count" -gt 1 ]; then
            echo "is_grouped=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Grouped PR detected: $count dependencies"
          else
            echo "is_grouped=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  Single dependency PR (will be handled by main workflow)"
          fi

  # Claude review for GROUPED Dependabot PRs
  claude-review-grouped:
    name: Claude Review (Grouped Dependencies)
    runs-on: ubuntu-latest
    needs: detect-group
    if: |
      github.actor == 'dependabot[bot]' &&
      needs.detect-group.outputs.is-grouped == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install reviewdog
        uses: reviewdog/action-setup@v1
        with:
          reviewdog_version: latest

      - name: Fetch metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Claude Review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            This is a GROUPED Dependabot PR updating MULTIPLE dependencies:

            **Dependencies**: ${{ steps.metadata.outputs.dependency-names }}
            **Highest severity**: ${{ steps.metadata.outputs.update-type }}
            **Package ecosystem**: ${{ steps.metadata.outputs.package-ecosystem }}
            **PR**: #${{ github.event.pull_request.number }}

            ‚ö†Ô∏è IMPORTANT: This PR contains ${{ needs.detect-group.outputs.dependency-count }} dependencies.
            You MUST analyze EACH dependency individually.

            ## Your Task

            1. **Parse the PR changes** to identify each dependency and its version change
               - Use `gh pr diff` to see package.json/package-lock.json changes
               - Extract: package name, old version, new version, update type for EACH

            2. **Categorize each dependency** by update type:
               - Patch updates (bug fixes)
               - Minor updates (new features)
               - Major updates (breaking changes)

            3. **Analyze each category**:

               **For PATCH updates**:
               - Quick validation that changes look reasonable
               - Note any unexpected changes

               **For MINOR updates**:
               - Review changelogs for new features
               - Identify beneficial features for this codebase
               - Create GitHub issues for significant opportunities

               **For MAJOR updates**:
               - Analyze breaking changes in detail
               - Search codebase for affected usage
               - For SIMPLE fixes (< 10 lines): Implement fixes locally and use reviewdog to create suggestions
               - For COMPLEX fixes: Create migration issues with detailed steps

               **Simple fixes workflow**:
               1. Use Edit/Write to implement fixes locally
               2. Run `npm test` and `npm run lint` to verify
               3. Use reviewdog to post changes as GitHub suggestions:
                  ```bash
                  TMPFILE=$(mktemp)
                  git diff > "${TMPFILE}"
                  export REVIEWDOG_GITHUB_API_TOKEN="${{ secrets.GITHUB_TOKEN }}"
                  reviewdog -f=diff -f.diff.strip=1 -reporter=github-pr-review < "${TMPFILE}"
                  git stash -u && git stash drop
                  rm -f "${TMPFILE}"
                  ```

            4. **Provide comprehensive summary** with structure:
               ```
               ## Grouped Dependency Review

               ### Summary
               - X patch updates (low risk)
               - Y minor updates (new features available)
               - Z major updates (breaking changes)

               ### Patch Updates ‚úÖ
               - package-a: v1.0.0 ‚Üí v1.0.1 (bug fixes)
               - package-b: v2.3.4 ‚Üí v2.3.5 (security fix)

               ### Minor Updates ‚¨ÜÔ∏è
               - package-c: v3.0.0 ‚Üí v3.1.0
                 - New feature: XYZ (created issue #123)

               ### Major Updates ‚ö†Ô∏è
               - package-d: v4.0.0 ‚Üí v5.0.0
                 - Breaking change: ABC
                 - Impact: [analysis]
                 - Action: [fix in PR / create migration issue / approve if no impact]

               ### Overall Recommendation
               [APPROVED / NEEDS FIXES / MIGRATION REQUIRED]
               ```

            5. **Take appropriate actions**:
               - Create enhancement issues for beneficial minor features
               - Create migration issues for complex major updates
               - Implement fixes in PR if major breaking changes are simple
               - Approve if all updates are safe

            6. **Final comment** with your summary and recommendation

            ## Tools Available

            - `Edit`, `Write` - Make local code changes to fix breaking changes
            - `Bash(npm test)`, `Bash(npm run lint)` - Verify fixes work
            - `Bash(reviewdog ...)` - Post changes as GitHub inline suggestions
            - `Bash(gh pr diff:*)`, `Bash(gh pr view:*)` - View PR details
            - `Bash(gh pr comment:*)`, `Bash(gh issue create:*)` - PR/issue management
            - `WebFetch`, `WebSearch` - Find changelogs
            - `Read`, `Grep`, `Glob` - Analyze codebase impact

            ## Approval Markers

            Use one of these in your final comment:
            - ‚úÖ **APPROVED** - All updates safe to merge after CI passes
            - üîß **FIXABLE** - Simple breaking changes found, implemented locally and posted as suggestions
            - ‚ö†Ô∏è **REVIEW NEEDED** - Complex issues require human review
            - ‚ö†Ô∏è **MIGRATION REQUIRED** - Created migration issues, manual work needed

          claude_args: '--allowed-tools "Edit,Write,Bash(npm *),Bash(git *),Bash(reviewdog *),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh issue create:*),WebFetch,WebSearch,Read,Grep,Glob"'

  # Auto-merge decision for grouped PRs
  auto-merge-grouped:
    name: Auto-Merge Decision (Grouped)
    runs-on: ubuntu-latest
    needs: [detect-group, claude-review-grouped]
    if: |
      always() &&
      github.actor == 'dependabot[bot]' &&
      needs.detect-group.outputs.is-grouped == 'true' &&
      needs.claude-review-grouped.result == 'success'

    steps:
      - name: Fetch metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check Claude approval
        id: check-approval
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          # Get the latest comment from claude[bot]
          latest_comment=$(gh pr view "$PR_URL" --json comments --jq '.comments | map(select(.author.login == "claude[bot]")) | last | .body')

          echo "Latest Claude comment:"
          echo "$latest_comment"

          # Check if Claude approved for auto-merge
          # Only APPROVED marker enables auto-merge
          # FIXABLE, MIGRATION REQUIRED, REVIEW NEEDED all require manual intervention
          if echo "$latest_comment" | grep -q "‚úÖ \*\*APPROVED\*\*"; then
            echo "approved=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Claude approved the grouped changes"
          else
            echo "approved=false" >> $GITHUB_OUTPUT
            if echo "$latest_comment" | grep -q "üîß \*\*FIXABLE\*\*"; then
              echo "‚ö†Ô∏è  Claude identified fixable breaking changes - manual fixes required"
            elif echo "$latest_comment" | grep -q "‚ö†Ô∏è \*\*MIGRATION REQUIRED\*\*"; then
              echo "‚ö†Ô∏è  Claude identified complex migration needed"
            elif echo "$latest_comment" | grep -q "‚ö†Ô∏è \*\*REVIEW NEEDED\*\*"; then
              echo "‚ö†Ô∏è  Claude requires human review"
            else
              echo "‚ö†Ô∏è  Claude did not approve for auto-merge"
            fi
          fi

      - name: Auto-approve if Claude approved
        if: steps.check-approval.outputs.approved == 'true'
        run: gh pr review --approve "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable auto-merge for dev dependencies
        if: |
          steps.check-approval.outputs.approved == 'true' &&
          steps.metadata.outputs.dependency-type == 'direct:development'
        run: |
          gh pr merge --auto --squash "$PR_URL"
          gh pr edit "$PR_URL" --add-label "dependabot-auto-merge"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Label for manual merge (prod deps or major updates)
        if: |
          steps.check-approval.outputs.approved == 'true' &&
          (steps.metadata.outputs.dependency-type == 'direct:production' ||
           steps.metadata.outputs.update-type == 'version-update:semver-major')
        run: |
          gh pr edit "$PR_URL" --add-label "dependabot-approved" --add-label "ready-to-merge"
          gh pr comment "$PR_URL" --body "‚úÖ **Claude approved** - Grouped PR ready for manual merge after CI passes."
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
